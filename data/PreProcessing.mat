clear all;
load('GBMLGG.Data.p.mat');

Features = Features';
%% Prepare Integrated Dataset
% Set desired features
desired_types = ['Clinical'; 'Protein '; 'Mutation'; 'CNV-Arm '; 'CNV-Gene']; 

% Pick desired features
desired = all(ismember(SymbolTypes, desired_types), 2);
Integ_X = Features(:, desired);
Integ_Symbs = Symbols(desired, :);
Integ_Symb_Types = SymbolTypes(desired,:);

% Remove patients with > 20% missing values
JunkPatients = (sum(isnan(Integ_X')) > .2 * size(Integ_X, 2)) | isnan(Survival) | isnan(Censored);
Integ_X = Integ_X(~JunkPatients,:);
Patients = Samples(~JunkPatients,:);
Survival = Survival(~JunkPatients)';
Censored = Censored(~JunkPatients)';

% Remove features with still > 20% missing values
JunkFeatures = sum(isnan(Integ_X)) > .2 * size(Integ_X, 1) | (min(Integ_X) == max(Integ_X));
Integ_X = Integ_X(:,~JunkFeatures);
Integ_Symbs = Integ_Symbs(~JunkFeatures, :);
Integ_Symb_Types = Integ_Symb_Types(~JunkFeatures, :);

% Impute Missing Values
Integ_X = knnimpute(Integ_X')';
% Normalize 
Integ_X = zscore(Integ_X);

save('Brain_Integ.mat', 'Integ_X', 'Survival', 'Censored', 'Integ_Symbs', 'Integ_Symb_Types', 'Patients');

%% Prepare Basic Dataset
% For the basic model we indlude IDH, 1P, and 19Q
t1 = mat2cell(Integ_Symbs(:, 1:10), ones(398, 1), 10);
t2 = ['IDH1_Mut  '; 'IDH2_Mut  '; '1p_CNVArm '; '19q_CNVArm'];
idhcodel = zeros(size(Integ_Symbs, 1), 1);
for tind = 1:4
    idhcodel = idhcodel | strcmp(t2(tind, :), t1);
end

desired = all(ismember(Integ_Symb_Types, 'Clinical'), 2) | idhcodel;
Basic_X = Integ_X(:, desired);
Basic_Symbs = Integ_Symbs(desired, :);
Basic_Symb_Types = Integ_Symb_Types(desired, :);

save('Brain_Basic.mat', 'Basic_X', 'Survival', 'Censored', 'Basic_Symbs', 'Basic_Symb_Types', 'Patients');
